name: Go

on:
    push:
    pull_request:

permissions:
    contents: read
    security-events: write

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v4.3.1
              with:
                  fetch-depth: 0

            - name: Install Go
              uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
              with:
                  go-version-file: go.mod

            - name: Run linters
              uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
              with:
                  problem-matchers: true
                  args: --output.sarif.path linter-results.sarif

            - name: Upload SARIF to Code Scanning
              if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
              uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
              with:
                  sarif_file: ./linter-results.sarif

    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v4.3.1
              with:
                  fetch-depth: 0

            - name: Install Go
              uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
              with:
                  go-version-file: go.mod

            - name: Verify go version
              run: |
                  echo "GOVERSION=$(go version)" >> $GITHUB_ENV
                  go version

            - name: Run tests
              run: go test -v -covermode=count -coverprofile=coverage.out ./...

            - name: Coveralls
              uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b # v2.3.6
              with:
                  github-token: ${{ secrets.github_token }}
                  file: coverage.out
                  format: golang
